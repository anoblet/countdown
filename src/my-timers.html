<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="my-timer.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-timers">
  <template>
    <style include="shared-styles">
      :host {
        display: grid;
        grid-gap: 1rem;
        padding: 1rem;
      }

      paper-card .card-content {
        padding: 1rem;
        font-size: var(--font-size);
      }
    </style>
    <app-route
            route="{{route}}"
            pattern="[[rootPath]]:id"
            data="{{routeData}}"
    >
    </app-route>
    <template is="dom-if" if="[[timersLoaded]]">
      <template is="dom-if" if="[[isSingle]]">
        <paper-card on-tap="selectTimer">
          <div class="card-content">
            <my-timer label="[[_getLabel(routeData.id)]]" date="[[_getDate(routeData.id)]]"></my-timer>
          </div>
        </paper-card>
      </template>
      <template is="dom-if" if="[[!isSingle]]">
        <template is="dom-repeat" items="[[query]]" as="timer">
          <paper-card on-tap="selectTimer">
            <div class="card-content">
              <my-timer id="[[index]]" label="[[timer.label]]" date="[[timer.date]]"></my-timer>
            </div>
          </paper-card>
        </template>
        <paper-card>
          <div class="card-content">
            <paper-input label="Label" value="{{newLabel}}"></paper-input>
            <paper-input label="Date" value="{{newDate}}"></paper-input>
          </div>
          <div class="card-cations">
            <paper-button on-tap="createTimer">Add</paper-button>
          </div>
        </paper-card>
      </template>
    </template>
    <firebase-query
            path="/users/[[userId]]/timers"
            data="{{query}}">
    </firebase-query>
    <firebase-document
            path="/users/[[userId]]/timers"
            data="{{timers}}">
    </firebase-document>
  </template>

  <script>
    class MyTimers extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() {
        return 'my-timers';
      }

      static get properties() {
        return {
          timers: {
            type: Array,
          },
          timersLoaded: {
            type: Boolean,
            value: false
          },
          userId: {
            type: String,
            value: 0
          }
        }
      }

      static get observers() {
        return [
          '_timersLoaded(timers.length)',
          '_routePathChanged(route.path)',
          '_idChanged(routeData.id)'
        ]
      }

      _timersLoaded(length) {
        if(length) this.set("timersLoaded", true);
      }

      createTimer() {
        const timer = {
          label: this.newLabel,
          date: this.newDate
        };
        if(!Array.isArray(this.timers)) this.set("timers", []);
        this.push("timers", timer)
      }

      selectTimer(e) {
        const id = e.target.getAttribute('id');
        window.history.pushState({}, null, '/timers/' + id);
        window.dispatchEvent(new CustomEvent('location-changed'));
      }

      _routePathChanged(path) {
        if(path == '') this.routeData = {};
      }

      _idChanged(id) {
        id !== undefined ? this.isSingle = true : this.isSingle = false;
      }

      _getLabel(id) {
        if(id) return this.timers[id].label;
      }

      _getDate(id) {
        if(id) return this.timers[id].date;
      }
    }

    window.customElements.define(MyTimers.is, MyTimers);
  </script>
</dom-module>
